#include <string.h>
#include <stdint.h>
#include "main.h"
#include "splash.h"

extern void DrawString(const char* str, uint8_t x, uint8_t y);

uint8_t* VG75 = (uchar*)0xC000;
uint8_t* VT57 = (uchar*)0xE000;
uint8_t* vv55 = (uint8_t*)0xc200;
uint8_t* radio86rkVideoMem = (uchar*)(SCREEN + 78*3 + 8);
uint8_t  radio86rkVideoBpl = 78;
unsigned char coordata[2];
extern uint8_t* put_sprite_3;
extern unsigned  char dino3[];
extern unsigned  char dino2[];
extern unsigned  char dino1[];
extern unsigned char ground1[];
extern unsigned char ground2[];
extern unsigned char ground3[];
uint8_t end;
uint16_t score=0; 
extern char i_a;
extern char i_b;
extern char i_c;
extern char i_d;

unsigned char best_bmp[26] = {3,8,
	 0x13, 0x10, 0x13, 0x01, 0x12, 0x01, 0x07, 0x01,
         0x13, 0x10, 0x13, 0x01, 0x02, 0x10, 0x06, 0x00, 
	 0x03, 0x00, 0x03, 0x01, 0x03, 0x00, 0x02, 0x00
};
unsigned char score_bmp[38] = {3,12,
	0x04, 0x03, 0x04, 0x03, 0x10, 0x12, 0x05, 0x06, 0x03, 0x10, 0x13, 0x01,
        0x00, 0x05, 0x06, 0x00, 0x10, 0x11, 0x06, 0x06, 0x14, 0x01, 0x13, 0x01,
        0x02, 0x01, 0x00, 0x03, 0x00, 0x02, 0x01, 0x02,	0x00, 0x01, 0x03, 0x01
};
unsigned char game_over[202] = {
4,50,	
	
	
	0x17, 0x17, 0x03, 0x03, 0x17, 0x17, 0x17, 0x17, 0x03, 0x07, 0x17, 0x17, 0x17, 0x13, 0x17, 0x13, 
	0x17, 0x17, 0x17, 0x13, 0x03, 0x03, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x03, 0x07, 0x17, 
	0x17, 0x17, 0x13, 0x17, 0x13, 0x17, 0x17, 0x17, 0x13, 0x03, 0x03, 0x17, 0x17, 0x17, 0x13, 0x03, 
	0x07, 0x17, 0x17, 0x11, 0x17, 0x03, 0x17, 0x17, 0x17, 0x11, 0x17, 0x11, 0x17, 0x17, 0x17, 0x11, 
	0x02, 0x00, 0x17, 0x17, 0x17, 0x11, 0x03, 0x07, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x11, 0x17, 
	0x11, 0x17, 0x17, 0x17, 0x11, 0x07, 0x01, 0x17, 0x17, 0x17, 0x11, 0x03, 0x07, 0x17, 0x17, 0x17, 
	0x11, 0x17, 0x01, 0x17, 0x17, 0x15, 0x03, 0x01, 0x17, 0x17, 0x17, 0x11, 0x14, 0x10, 0x17, 0x17, 
	0x17, 0x11, 0x15, 0x11, 0x17, 0x17, 0x17, 0x11, 0x03, 0x03, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 
	0x15, 0x03, 0x05, 0x17, 0x17, 0x17, 0x17, 0x10, 0x16, 0x17, 0x17, 0x17, 0x11, 0x03, 0x03, 0x17, 
	0x17, 0x17, 0x11, 0x14, 0x02, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 
	0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 
	0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 
	0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17

};
void waitVSync() {
 #asm
    lxi h,0c001h
    mov a,m
waitVSync_1:
    mov a, m
    ani 20h
    jz waitVSync_1
  #endasm
}








void screen_setup(uint video_mem,uint length)
{
  VG75[1] = 0; //
  VG75[0] = 0x4d; //
  VG75[0] = 0x22; //
  VG75[0] = 0x1e; //7e
  VG75[0] = 0x53; //
  VG75[1] = 0x23; //
  waitVSync();
  VT57[8] = 0x80; //
  VT57[4] = (uchar)(video_mem); //
  VT57[4] = (uchar)((video_mem)>>8); //
  VT57[5] = (uchar)((length)-1); //
  VT57[5] = 0x40 | (uchar)(((length)-1)>>8); //
  VT57[8] = 0xA4; //	
}

uint8_t key_scan(uint8_t row) // возвращает код нажатой клавиши
{
	uchar z = 0;
	vv55[0] = row;
	return vv55[1];
}

 uint8_t GetInput()
{
  uint8_t kb;
  kb=0xff;

//dig=key_scan(0xfb);//fb - 1(253)2(251)3(247)4(239)5(223)6(191)7(127)
 kb=key_scan(0x7e); //7e = f1 f2 f3 f4 f5 space y z x
   if (kb==127) //space
    {
        return KEY_space;
    }

 kb=key_scan(0xfd);
   if (kb==251)
    {
       return KEY_enter;
    }

   if (kb==223)
    {
      
        return KEY_up;
    }
   if (kb==127)
    {
       return KEY_down;
    }
   if (kb==239)
    {
      return KEY_left;
    }
   if (kb==191)
    {
        return KEY_right;
    }
return kb;

}


uint16_t GetRandFromSeed(uint16_t randVal)
{
	uint16_t lsb = randVal & 1;
	randVal >>= 1;
	if (lsb == 1) randVal ^= 0xB400u;
    	return randVal;
}

uint16_t GetRand()
{
	static uint16_t randVal = 0xABC;

	randVal = GetRandFromSeed(randVal);
  
   return randVal;
}

int random(int min, int max)
{
     if(min >= max) {
        return min;
    }
    return min + GetRand() % (max - min);
}







void about(void)
{
clrscr();
create_table();
put_sprite_3 = about_scr;//
put_sprite(8,4);
DrawString("This game was written by  ", 21, 30);
DrawString("Pashkevich M A in 2024 SPB", 21, 36);
DrawString("in Z88DK C for RADIO 86RK ", 21, 42);
DrawString("Beta Version              ", 21, 48);
while(key_scan(0xfd)!=251);
}


void main() {
int n;
char s;

uint16_t best_score = 0; 
clrscr();
screen_setup(SCREEN,2730);
create_table();

put_sprite_3 = zastavka;//
put_sprite(8,4);

while(key_scan(0xfd)!=251)
{
if (key_scan(0x7e)==127)
    {
     about();
     break;
    }

}
clrscr();
create_table();



i_a=0;i_b=0;i_c=0;i_d=1;      
start_game:
score = (i_a*1000)+(i_b*100)+(i_c*10)+i_d-1;
i_a=0;i_b=0;i_c=0;i_d=0;
if (best_score<score) best_score = score;
dino_init();
cactus_init();
ptero_init();
score = 0;
put_sprite_3 = best_bmp;//
put_sprite(7,3);
DrawUInt(best_score, 23, 3); 
put_sprite_3 = score_bmp;//
put_sprite(52,3);

  while(1) 
  {
check_player();
cactus_check();
ptero_check();



waitVSync();
scroll();

cactus_core();
dino_core();
ptero_core();
DrawScore(66, 3); 
inc_score(); 
if (end==1) break;
  }

put_sprite_3 = game_over;//
put_sprite(16,6);

while(key_scan(0xfd)!=251);
clrscr();
create_table();
end =0;
goto start_game;
}



















